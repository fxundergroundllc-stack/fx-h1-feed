name: update-fx-h1

on:
  schedule:
    - cron: "5 * * * *"      # co godzinę o :05 UTC
  workflow_dispatch: {}       # ręczne uruchomienie

permissions:
  contents: write

concurrency:
  group: update-fx-h1
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -U pandas numpy requests

      # --- (opcjonalne) Twoje dotychczasowe kroki; nie blokują testu ---
      - name: Fetch H1 OHLC CSVs (optional)
        run: |
          if [ -f scripts/fetch_fx_h1.py ]; then
            python scripts/fetch_fx_h1.py
          else
            echo "scripts/fetch_fx_h1.py not found - skipping"
          fi
        continue-on-error: true

      - name: Build setups from CSVs (optional)
        run: |
          if [ -f scripts/build_setups.py ]; then
            python scripts/build_setups.py
          else
            echo "scripts/build_setups.py not found - skipping"
          fi
        continue-on-error: true

      - name: Build PRO signals (optional)
        run: |
          if [ -f scripts/build_pro_signals.py ]; then
            python scripts/build_pro_signals.py
          else
            echo "scripts/build_pro_signals.py not found - skipping"
          fi
        continue-on-error: true
      # ------------------------------------------------------------------

      # >>> KLUCZOWY KROK: dopisz testowy SELL EURUSD zgodny ze starym EA <<<
      - name: Append IMMEDIATE TEST row (EURUSD SELL, SL/TP 10 pips) — legacy EA compatible
        run: |
          python - << 'PY'
          import os, csv
          from datetime import datetime, timezone
          entry = None

          # Spróbuj wziąć ostatni close z data/EURUSD.csv (jeśli jest),
          # bo stare EA zwykle używa MARKET z aktualną ceną/entry z CSV.
          try:
              import pandas as pd
              if os.path.exists("data/EURUSD.csv"):
                  df = pd.read_csv("data/EURUSD.csv")
                  cols = {c.lower(): c for c in df.columns}
                  tcol = cols.get("timestamp") or cols.get("time") or cols.get("datetime") or list(df.columns)[0]
                  ccol = cols.get("close") or "close"
                  df = df.rename(columns={tcol:"timestamp", ccol:"close"})
                  entry = float(df.tail(1)["close"].values[0])
          except Exception as e:
              print("Data read warning:", e)

          if entry is None:
              entry = 1.00000   # fallback, gdy brak danych

          pip = 0.0001
          sl  = entry + 10*pip
          tp  = entry - 10*pip

          os.makedirs("signals", exist_ok=True)
          p_csv = "signals/mt4.csv"

          # Jeżeli plik istnieje, zachowaj jego nagłówek; w przeciwnym razie użyj podstawowego
          header = []
          rows   = []
          if os.path.exists(p_csv):
              with open(p_csv, encoding="utf-8") as f:
                  r = list(csv.reader(f))
              if r:
                  header = r[0]
                  rows   = r[1:]

          if not header:
              header = ['pair','direction','entry','sl','tp','stop_pips','lot_size','risk_pct','risk_usd','issued_at']

          # Zbuduj mapę wartości w "starym" formacie (bez dodatkowych kolumn)
          row_map = {
              'pair':'EURUSD',
              'direction':'short',
              'entry':f"{entry:.5f}",
              'sl':f"{sl:.5f}",
              'tp':f"{tp:.5f}",
              'stop_pips':"10",
              'lot_size':"0.01",
              'risk_pct':"",
              'risk_usd':"",
              'issued_at':datetime.now(timezone.utc).isoformat()
          }

          # Złóż wiersz zgodnie z aktualnym nagłówkiem (dla nieznanych kolumn -> "")
          out = [row_map.get(c,"") for c in header]

          with open(p_csv, 'w', newline='', encoding='utf-8') as f:
              w = csv.writer(f)
              w.writerow(header)
              w.writerows(rows)
              w.writerow(out)

          print("Appended legacy TEST row: EURUSD, short, 0.01 lot, SL/TP=10 pips")
          PY

      - name: Commit & push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update: append LEGACY TEST EURUSD short 0.01 SL/TP 10 pips"
          # commitujemy wszystko, żeby nie zgubić mt4.csv
