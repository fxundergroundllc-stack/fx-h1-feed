name: update-fx-h1

on:
  schedule:
    - cron: "0 * * * *"      # Równo o :00 UTC po zamknięciu świecy H1
  workflow_dispatch: {}       # Ręczne uruchomienie

permissions:
  contents: write

concurrency:
  group: update-fx-h1
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -U pandas numpy requests

      # (Opcjonalnie) pobierz dane H1 z Twelve Data, jeśli masz secret
      - name: Fetch H1 OHLC CSVs (optional)
        env:
          TWELVE_DATA_KEY: ${{ secrets.TWELVE_DATA_KEY }}
        run: |
          if [ -f scripts/fetch_fx_h1.py ]; then
            python scripts/fetch_fx_h1.py || echo "fetch_fx_h1.py failed (missing key?) — continuing"
          else
            echo "scripts/fetch_fx_h1.py not found - skipping"
          fi

      # Generator sygnałów – tylko NA CZASIE, bez „spóźnionych”
      - name: Build setups from CSVs
        env:
          EMIT_PAST_CROSS: "false"     # ustaw "true", jeśli chcesz jednorazowo nadrobić stare crossy
          FRESH_MAX_HOURS: "2"         # dane muszą być świeższe niż X godzin
        run: python scripts/build_setups.py

      # TEST EURUSD – zostaw "true" dopóki testujesz, potem zmień na "false"
      - name: Append LEGACY TEST row (EURUSD SELL, SL/TP 10 pips)
        env:
          APPEND_TEST: "true"
        run: |
          if [ "${APPEND_TEST}" != "true" ]; then
            echo "Skipping test row"; exit 0; fi
          python - << 'PY'
          import os, csv
          from datetime import datetime, timezone
          entry = None
          try:
              import pandas as pd
              if os.path.exists("data/EURUSD.csv"):
                  df = pd.read_csv("data/EURUSD.csv")
                  cols = {c.lower(): c for c in df.columns}
                  tcol = cols.get("timestamp") or cols.get("time") or cols.get("datetime") or list(df.columns)[0]
                  ccol = cols.get("close") or "close"
                  df = df.rename(columns={tcol:"timestamp", ccol:"close"})
                  entry = float(df.tail(1)["close"].values[0])
          except Exception as e:
              print("Data read warning:", e)
          if entry is None: entry = 1.00000
          pip = 0.0001; sl = entry + 10*pip; tp = entry - 10*pip
          os.makedirs("signals", exist_ok=True)
          p_csv = "signals/mt4.csv"
          header, rows = [], []
          if os.path.exists(p_csv):
              import csv as _csv
              with open(p_csv, encoding="utf-8") as f:
                  r = list(_csv.reader(f))
              if r: header, rows = r[0], r[1:]
          if not header:
              header = ['pair','direction','entry','sl','tp','stop_pips','lot_size','risk_pct','risk_usd','issued_at']
          row_map = {'pair':'EURUSD','direction':'short','entry':f"{entry:.5f}",
                     'sl':f"{sl:.5f}",'tp':f"{tp:.5f}",'stop_pips':"10",'lot_size':"0.01",
                     'risk_pct':"",'risk_usd':"",'issued_at':datetime.now(timezone.utc).isoformat()}
          out = [row_map.get(c,"") for c in header]
          with open(p_csv,'w',newline='',encoding='utf-8') as f:
              w=csv.writer(f); w.writerow(header); w.writerows(rows); w.writerow(out)
          print("Appended legacy TEST row")
          PY

      - name: Commit & push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update: on-time EMA cross signals + debug (+ optional test)"
